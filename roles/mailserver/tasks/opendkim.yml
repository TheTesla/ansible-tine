---

- name: Install opendkim
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - opendkim
    - opendkim-tools
  notify: 
    - opendkim keys
    - domain update

- name: Create opendkim directories 
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: 0755
    state: directory
  with_items:
    - "/etc/opendkim/keys"

- name: Copy opendkim config file
  copy:
    src: "../templates/etc/opendkim.conf"
    dest: "/etc/opendkim.conf"

- name: Process opendkim templates
  template:
    src: "{{ item.src }}"
    dest: "/etc/opendkim/{{ item.path }}"
  with_filetree: "../templates/etc/opendkim/"
  when: item.state == 'file'
  notify:
    - Restart opendkim

- name: Add user postfix to group opendkim
  user:
    name: postfix
    groups: opendkim
    append: yes




